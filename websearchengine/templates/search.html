<!DOCTYPE html>
{% load static %}
<html>

<head>
    <title>Search Results</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">

</head>

<body>

    <nav class="navbar" style="background-color: #e3f2fd;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                Cyberminer
            </a>
        </div>

    </nav>

    <br>
    <br>
    <div class="inputArea">
        <div class="container-sm">
            <form action="{% url 'search' %}" method="post">
                {% csrf_token %}
                <div class="input-group mb-3">
                    <input type="text" name="searchInput" class="form-control" placeholder="Enter keyword"
                        aria-describedby="button-addon1" id="searchInput">
                    <button class="btn btn btn-info" type="submit" id="button-addon1">Search</button>
                </div>
                <div class="resultBox">
                  <ul class="list-group autofillList">
                      <!-- here list are inserted from javascript -->
                  </ul>

                </div>
            </form>
            <div class="row">
                <div class="col-md-1">
                    <form action="{% url 'search' %}" method="post">
                        {% csrf_token %}
                        <select name="search_type" class="btn btn-outline-info dropdown-toggle heading_class"
                            type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <option value="AND">AND</option>
                            <option value="OR">OR</option>
                            <option value="NOT">NOT</option>
                        </select>
                    </form>
                </div>
                <div class="col-md-6" style="width: 180px">
                    <form id="sortForm" action="{% url 'sort' %}" method="post">
                        {% csrf_token %}
                        <select id="sortSelect" name="sort_by"
                            class="btn btn-outline-info dropdown-toggle heading_class" onchange="submitForm()">
                            <option value="">Sort By</option>
                            <option value="alphabetical">Alphabetical</option>
                            <option value="access_frequency">Most Frequently accessed</option>
                            <option value="payment">According to payment</option>
                        </select>
                    </form>
                </div>
                <div class="col-md-11" style="padding-left: 90px;padding-top: 10px;padding-right: 0px;width: 207px;">
                    About {{ total_results }} results
                </div>
            </div>
        </div>
    </div>
    <div class="container-md search_container_style">
        <h5 class="search_container_style" style="padding-top: 20px;padding-bottom: 10px;">Search Results</h5>
        {% if not query_result.empty %}
        {% for _, result in query_result.iterrows %}
        <div class="result">
            <table class="table">
                <h4>{{ result.headlines }}</h4>
                <a href="{{ result.url }}">{{ result.url }}</a>
                <p>{{ result.short_description }}</p>
                <br>
            </table>
        </div>
        {% endfor %}
        {% else %}
        <p>No results found.</p>
        {% endif %}
    </div>

    {% block content %}
    <!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css"> -->

    <script>
        function submitForm() {
            document.getElementById("sortForm").submit();
        }
    </script>
    <style>
        #autocompleteList {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
        }

        #autocompleteList li {
            padding: 5px;
            cursor: pointer;
            background-color: #f9f9f9;
        }

        #autocompleteList li:hover {
            background-color: #e9e9e9;
        }
    </style>
    <script>
        $(document).ready(function () {
            fetch('/headlines/')
                .then(response => {
                    console.log(response);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    // Store the headlines_list globally so that it can be used in other functions
                    var headlines_list = data;

                    $(".form-control").on("input", function () {
                        var keyword = $(this).val();
                        console.log(keyword);

                        // Use slice to get the first 10 headlines
                        if(keyword!=""){
                        var headlinesToShow = headlines_list.slice(0,5000);
                        var autocompleteList = $(".autofillList");
                        autocompleteList.empty();
                        headlinesToShow.forEach((item, i) => {
                        if(item.includes(keyword)){
                          var listItem = $('<li  class="list-group-item">').text(item);
                          autocompleteList.append(listItem);
                        }

                        });

                        autocompleteList.show();
                    }

                    else{
                      $(".autofillList").hide();
                    }
                    });

                    $(".resultBox").on("click", "li", function () {
                        var selectedSuggestion = $(this).text();
                        console.log(selectedSuggestion);
                        $("#searchInput").val(selectedSuggestion);
                        $(".autofillList").hide();
                    });
                })
                .catch(error => {
                    console.error("Error fetching headlines.json:", error);
                });
        });
    </script>
    {% endblock %}
</body>

</html>
